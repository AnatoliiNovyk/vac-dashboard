Промпт: Імпорт/Експорт співробітників з 1С BAS (BAF) — тільки “HR View”

Обов’язково

- Суворо дотримуйся системного промпта: 3 статуси; без “заявок/затверджень”; ролі/вкладки; HR може редагувати всі дані співробітника; нічого не видаляти; після кожного кроку — новий changelog у changelogs/.
- Кнопки “Імпорт з BAS” і “Експорт у BAS” доступні лише у вкладці “HR View” і лише для користувачів із роллю HR (у т.ч. HR‑керівник). В інших вкладках кнопок бути не повинно.
- Будь-яка інтеграція з BAS має бути вимикається фіче‑прапором FEATURES.BAS_SYNC_ENABLED (за замовчуванням true/як домовлено).

Бізнес‑вимоги

- Імпорт: отримати з BAS довідник співробітників та пов’язані дані, створити/оновити записи у нашій БД з audit‑логом, без дублювань.
- Експорт: сформувати файл/пакет або відправити через API для BAS з актуальними співробітниками та їх ключовими атрибутами.
- Формати: підтримати щонайменше CSV/JSON; опційно XML (якщо у вас затверджений формат для BAS). Зробити шар мапінгу, щоб легко переключати спосіб інтеграції (файл/HTTP/обробка BAS).
- Ідempotентність: повторний імпорт не має створювати дублі (матчинг за external_id або tax_id + full_name + birth_date).
- Валідація: обов’язкові поля при імпорті — external_id, full_name, department, position, email (або phone), manager_external_id (якщо є вертикаль), employment_status (active/inactive), allocation.total_allocated_days.
- Конфіденційність: жодних паролів/секретів у клієнтському коді; ключі/URL — у серверних змінних середовища.

UI/UX (тільки HR View)

- У блоці над таблицею співробітників додати 2 кнопки:
    - “Імпорт з BAS”
    - “Експорт у BAS”
- Поруч іконка “ℹ” з посиланням “Схема полів”, що відкриває модал із мапінгом полів.
- Для імпорту — модал:
    - спосіб: “Файл (CSV/JSON/XML)” або “HTTP Endpoint” (URL у налаштуваннях сервера);
    - drag\&drop для файлу; прев’ю перших N рядків; показ лічильника “буде створено/оновлено/пропущено”.
- Для експорту — модал:
    - вибір формату (CSV/JSON/XML);
    - фільтри (департамент, статус активності, дата оновлення);
    - опція “експортувати тільки зміни з дати …”.
- Після імпорту/експорту — toast з підсумком і лінком на audit‑лог.

Дані та мапінг полів

- Вхідні (з BAS) → Наші:
    - external_id → employees.external_id
    - full_name → employees.full_name
    - tax_id → employees.tax_id
    - email → employees.email
    - phone → employees.phone
    - department_code/name → departments.code/name (create‑or‑link)
    - position → employees.position
    - manager_external_id → employees.manager_id (через резолв зовнішнього ідентифікатора)
    - employment_status (active/inactive) → employees.active (boolean)
    - total_allocated_days (int) → allocations.total_allocated_days
    - location (optional) → employees.location
    - hire_date/termination_date (optional) → відповідні поля
- На вихід (у BAS) — цей же перелік, плюс timestamp останнього оновлення.

Back‑end (рекомендації)

- Ендпойнти:
    - POST /api/hr/bas/import (multipart для файлу або JSON body; запускає імпорт‑пайплайн)
    - GET  /api/hr/bas/export?format=csv|json|xml\&filters=… (стрім або архів)
    - GET  /api/hr/bas/mapping (повертає мапінг полів для модала)
- Пайплайн імпорту:
    - Парсер (CSV/JSON/XML) → Нормалізатор → Валідація (schema/Joi/Zod) → Match \& Upsert (транзакційно) → Пост‑процес (побудова вертикалі manager_id, створення відсутніх департаментів) → Аудит.
- Ідемпотентність:
    - Якщо external_id існує — оновлення; якщо ні — створення.
    - Якщо manager_external_id не знайдено — тимчасово скласти у “pending manager resolve” і другим проходом оновити manager_id.
- Логи та помилки:
    - API повертає підсумок: created/updated/skipped/errors[] із рядками‑причинами.
    - Зберігати audit записи (userId, when, counts, fileName/reqId).
- Безпека:
    - Доступ лише HR; перевірка ролі на бекенді.
    - Розмір файлу, тип контенту, timeout, ліміт кількості записів за операцію.

Front‑end

- Показувати кнопки лише якщо activeTab === 'HR' і роль HR.
- Для файлу:
    - Валідатор типу та розміру (наприклад, ≤ 10MB).
    - Після відправки — показувати progress (брейкдаун created/updated/skipped).
- Для HTTP‑експорту:
    - Скачування файлу з правильним content‑disposition (ім’я файлу: employees_YYYYMMDD_HHmm.format).

Сумісність із вертикаллю менеджерів

- Якщо приходять лише manager_external_id — спочатку зберегти всіх співробітників, потім другим проходом резолвити manager_id (через map external_id → id).
- У випадку відсутніх менеджерів — логувати і позначати як unresolved; не зривати операцію; дати повторити імпорт з доповненими даними.

Фіче‑прапори та конфіг

- FEATURES.BAS_SYNC_ENABLED: boolean — вимикає всі кнопки та логіку імпорту/експорту.
- SERVER_BAS_IMPORT_LIMIT: максимальна кількість записів за 1 імпорт.
- ALLOWED_IMPORT_FORMATS: [‘csv’, ‘json’, ‘xml’].
- EXPORT_DEFAULT_FORMAT: ‘csv’.

Перевірки (must pass)

- Кнопки видні лише у “HR View”, лише HR‑ролям.
- Імпорт: коректно створює/оновлює співробітників, департаменти, резолвить менеджерів другим проходом; показує підсумок без дублювань.
- Експорт: формує валідний файл/стрім з фільтрами і правильними назвами полів.
- Жодних змін у Manager/My View; таблиці/календар працюють; “Залишок” не ламається.
- Створено changelog з DIFF, скрінами та rollback.

Швидкий план кроків з changelog

- Крок 0: UI каркас у “HR View” (кнопки/модали) — без бекенду.
- Крок 1: Ендпойнт імпорту + парсери + валідація + upsert + audit.
- Крок 2: Ендпойнт експорту + формувач CSV/JSON/XML + фільтри.
- Крок 3: Вертикаль менеджерів — другий прохід, pending resolve, логування.
- Крок 4: Перевірки, великий файл, edge‑кейси, фіче‑прапор, документація мапінгу.

Якщо у вас є затверджений формат обміну з BAS (наприклад, конкретна XML‑схема або JSON‑контракт) — додайте його у промпт як додаток, і агент підлаштує парсер/серіалізатор під цей формат.
